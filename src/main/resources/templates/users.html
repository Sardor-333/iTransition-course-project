<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--favicon-->
    <link rel="icon" th:href="@{/assets/images/logo-icon.png}" type="image/png"/>

    <!--plugins-->
    <link th:href="@{/assets/plugins/simplebar/css/simplebar.css}" rel="stylesheet"/>
    <link th:href="@{/assets/plugins/perfect-scrollbar/css/perfect-scrollbar.css}" rel="stylesheet"/>
    <link th:href="@{/assets/plugins/metismenu/css/metisMenu.min.css}" rel="stylesheet"/>
    <!-- loader-->
    <link th:href="@{/assets/css/pace.min.css}" rel="stylesheet"/>
    <script th:src="@{/assets/js/pace.min.js}"></script>
    <!-- Bootstrap CSS -->
    <link th:href="@{/assets/css/users.css}" rel="stylesheet">
    <link th:href="@{/assets/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/assets/css/bootstrap-extended.css}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link th:href="@{/assets/css/app.css}" rel="stylesheet">
    <link th:href="@{/assets/css/icons.css}" rel="stylesheet">
    <!-- Theme Style CSS -->
    <link rel="stylesheet" th:href="@{/assets/css/dark-theme.css}"/>
    <link rel="stylesheet" th:href="@{/assets/css/semi-dark.css}"/>
    <link rel="stylesheet" th:href="@{/assets/css/header-colors.css}"/>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

    <title>Users</title>
</head>

<body>
<div class="wrapper">

    <div th:replace="fragments/sidebar :: sidebar"></div>

    <header th:replace="fragments/header :: header"></header>

    <div class="page-wrapper">
        <div class="page-content">

            <!--                 Response                   -->
            <div th:if="${response} != null">
                <p th:if="${response.success} == true" th:text="${response.message}"
                   class="alert alert-success"
                   role="alert">
                </p>
                <p th:if="${response.success} == false" th:text="${response.message}"
                   class="alert alert-danger"
                   role="alert">
                </p>
            </div>

            <div class="container-xl">
                <div class="table-responsive">
                    <div class="table-wrapper">
                        <div class="table-title">
                            <div class="row">
                                <div class="col-sm-5">
                                    <h2>User <b>Management</b></h2>
                                </div>
                                <div class="col-sm-7">
                                    <a href="#" class="btn btn-warning">Export to Excel</a>
                                </div>
                            </div>
                        </div>

                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>ID</th>
                                <th>Full Name</th>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Created Time</th>
                                <th>Updated Time</th>
                                <th>Logged Time</th>
                                <th>Status</th>
                                <th>Delete</th>
                                <th>Role</th>
                            </tr>
                            </thead>

                            <tbody>
                            <tr th:each="user: ${users.page}">

                                <!-- INDEX -->
                                <td th:text="${userStat.index + 1}"></td>

                                <!-- ID -->
                                <td th:text="${user.id}"></td>

                                <!-- Full Name -->
                                <td>
                                    <a th:if="${user.id == #authentication.getPrincipal().getId()}"
                                       th:text="You"
                                       data-toggle="modal"
                                       data-target=""
                                    >
                                    </a>

                                    <a th:if="!${user.id == #authentication.getPrincipal().getId()}"
                                       th:text="${user.firstName + ' ' + user.lastName}"
                                    >
                                    </a>
                                </td>

                                <!-- Username -->
                                <td th:text="${user.username}"></td>

                                <!-- Status -->
                                <td th:if="${user.enabled}">
                                    <span class="status text-success">&bull;</span>
                                    Active
                                </td>

                                <!-- Status -->
                                <td th:if="!${user.enabled}">
                                    <span class="status text-danger">&bull;</span>
                                    Blocked
                                </td>

                                <!-- Created at -->
                                <td th:text="${user.createdAt}"></td>

                                <!-- Updated at -->
                                <td th:text="${user.updatedAt}"></td>

                                <!-- Logged at -->
                                <td th:text="${user.loggedAt}"></td>

                                <!-- Block & Unblock -->
                                <td th:if="${user.role.name != 'ROLE_SUPER_ADMIN'}">
                                    <button th:if="${user.enabled}"
                                            class="btn btn-danger"
                                            th:text="Block"
                                            th:onclick="'enableOrDisableUser(\'' + ${user.id} + '\');'"></button>
                                    <button th:if="!${user.enabled}"
                                            class="btn btn-success"
                                            th:text="Unblock"
                                            th:onclick="'enableOrDisableUser(\'' + ${user.id} + '\');'"></button>
                                </td>

                                <!-- Delete -->
                                <td th:if="${user.role.name != 'ROLE_SUPER_ADMIN'}">
                                    <button class="btn btn-danger"
                                            th:text="Delete"
                                            th:onclick="'deleteUser(\'' + ${user.id} + '\');'">
                                    </button>
                                </td>

                                <!-- Change role -->
                                <td th:if="${user.role.name != 'ROLE_SUPER_ADMIN'}">
                                    <!-- IF ADMIN THEN MAKE USER -->
                                    <button class="btn btn-primary"
                                            th:if="${user.role.name == 'ROLE_ADMIN'}"
                                            th:text="#{menu.makeUser}"
                                            th:onclick="'changeRole(\'' + ${user.id} + '\');'">
                                    </button>

                                    <!-- IF USER THEN MAKE ADMIN -->
                                    <button class="btn btn-primary"
                                            th:if="${user.role.name == 'ROLE_USER'}"
                                            th:text="#{menu.makeAdmin}"
                                            th:onclick="'changeRole(\'' + ${user.id} + '\');'">
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!--     Pagination       -->
            <nav aria-label="Page navigation" class="paging">
                <ul class="pagination" th:if="${users.page.getTotalPages() > 1}">
                    <li class="page-item" th:classappend="${!users.paging.isPrevEnabled()? 'disabled' : ''}">
                        <a class="page-link" th:href="@{'/?page=' + ${users.paging.pageNumber - 1}}"
                           tabindex="-1" th:text="#{previous}"></a>
                    </li>
                    <th:block th:each="item : ${users.paging.getItems()}">
                        <li class="page-item"
                            th:classappend="${item.index == users.paging.pageNumber? 'active' : ''}"
                            th:if="${item.pageItemType.name() == 'PAGE'}">
                            <a class="page-link" th:href="@{'/?page=' + ${item.index}}"
                               th:text="${item.index}"></a>
                        </li>
                        <li class="page-item disabled" th:if="${item.pageItemType.name() == 'DOTS'}">
                            <a class="page-link" href="#">...</a>
                        </li>
                    </th:block>
                    <li class="page-item" th:classappend="${!users.paging.isNextEnabled()? 'disabled' : ''}">
                        <a class="page-link" th:href="@{'/?page=' + ${users.paging.pageNumber + 1}}"
                           th:text="#{next}"></a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<div th:replace="fragments/theme-customizer :: theme-customizer"></div>

<script>
    $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();
    });

    function enableOrDisableUser(userId) {
        fetch('/api/v1/users/profile/' + userId + '/enableOrDisable', {
            method: 'post'
        }).then(response => location.reload());
    }

    function deleteUser(userId) {
        fetch('/api/v1/users/' + userId, {
            method: 'delete'
        }).then(response => location.reload());
    }

    function changeRole(userId) {
        fetch('/api/v1/users/' + userId + '/changeRole', {
            method: 'post'
        }).then(response => location.reload());
    }

</script>
<script th:src="@{/assets/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/js/jquery.min.js}"></script>
<script th:src="@{/assets/plugins/simplebar/js/simplebar.min.js}"></script>
<script th:src="@{/assets/plugins/metismenu/js/metisMenu.min.js}"></script>
<script th:src="@{/assets/plugins/perfect-scrollbar/js/perfect-scrollbar.js}"></script>
<script th:src="@{/assets/js/app.js}"></script>

<script th:src="@{/webjars/jquery/jquery.min.js}"></script>
<script th:src="@{/webjars/popper.js/umd/popper.min.js}"></script>
<script th:src="@{/webjars/bootstrap/js/bootstrap.min.js}"></script>
</body>

</html>